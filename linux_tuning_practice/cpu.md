## cpu load averages
周期时间内“正在运行”或者”等待运行“的平均进程数。它和CPU的使用率没有什么关系。

## 压力测试工具
stress, sysbench

## CPU上下文
CPU上下文一般指任务执行时CPU寄存器和程序计数器保存的数据，分别用来保存当前执行的一些指令和程序执行点位置。

而CPU上下文切换就是多个任务在使用同一个CPU时，上述数据的交换切入和切出。

切换是有成本的。

### CPU上下文切换
如果同一个进程或者线程内发生系统调用，会发生上下文切换吗？我之前的理解是没有，其实肯定是有的。因为CPU上面的指令是需要从用户态切换到内核态执行的。

但是和进程上下文切换不同，因为进程都是独立的虚拟内存空间和全局环境变量，所以需要CPU切换这些数据。

### CPU切换时间点
1. 当前执行任务完成。
2. 系统资源不足时，比如内存不足，网络数据未达到，进程会挂起。
3. 通过sleep相关函数调用。
4. 多个任务竞争，且其它任务优先级更高时。
5. 硬件中断时，需要执行内核中的中断处理程序。

### 线程上下文切换
首先需要理解进程，线程的区别。内核中的任务调度，操作的对象都是线程切换。一句话总结：线程是调度的基本单位，进程是资源拥有的基本单位。
进程内所有线程共享所有内存，全局变量。

### 中断上下文切换
中断上下文切换和进程上下文不同，因为中断都是内核态的，所以没有虚拟内存和全局变量的切换。而且中断一般拥有更高的优先级。

### 上下文切换的成本
CPU上下文切换，会消耗很多时间在CPU寄存器和计数器在不断的存储和恢复上，缩短CPU真实计算的时间，导致利用率下降。

## 诊断工作
uptime, pidstat, vmstat, top, perf

短进程总是的诊断（创建后很快结束），需要使用pstree，execsnoop或者perf top。

![CPU性能指标](images/linux_tuning_cpu_01.png)
![CPU性能指标](images/linux_tuning_cpu_02.png)
![CPU性能指标](images/linux_tuning_cpu_03.png)
![CPU性能指标](images/linux_tuning_cpu_04.png)
